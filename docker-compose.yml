# docker-compose.yml
version: "3.9"

services:
  # Imagem base (Usada para build e tarefas manuais)
  app-base:
    build: .
    image: tasy-app:latest
    env_file: .env.docker
    volumes:
      - ./logs:/app/logs
      - ./output:/app/output
      - ./config:/app/config

  # NOVO: Interface Admin para edição de templates de e-mail
  # Adicionamos aqui para que ela fique rodando 24/7 na porta 8081
  admin-ui:
    image: tasy-app:latest
    env_file: .env.docker
    ports:
      - "8081:8080"  # 8081 no servidor -> 8080 do FastAPI (evita conflito com homolog)
    command: ["uvicorn", "app.api:app", "--host", "0.0.0.0", "--port", "8080"]
    restart: always

  # Stage 1 — Harvester (mantido conforme sua versão)
  harvester:
    image: tasy-app:latest
    env_file: .env.docker
    volumes:
      - ./logs:/app/logs
      - ./output:/app/output
      - ./config:/app/config
    entrypoint: ["bash", "-lc"]
    command: "python -m app.harvester --competencia $${COMPETENCIA} --contratos $${CONTRATOS}"

  # Stage 2 — Runner (mantido conforme sua versão)
  runner:
    image: tasy-app:latest
    env_file: .env.docker
    volumes:
      - ./logs:/app/logs
      - ./output:/app/output
      - ./config:/app/config
    entrypoint: ["bash", "-lc"]
    command: "python -m app.runner --help"

  # Orquestrador (mantido, mas com restart always para não cair)
  scheduler:
    image: tasy-app:latest
    env_file: .env.docker
    volumes:
      - ./logs:/app/logs
      - ./output:/app/output
      - ./config:/app/config
      - ./bin:/app/bin
    entrypoint: ["bash", "-lc"]
    command: "/app/bin/schedule.sh"
    restart: always